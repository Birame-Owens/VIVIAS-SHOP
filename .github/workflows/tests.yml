name: ğŸš€ Construction et Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ============================================
  # ğŸ§ª TESTS ET CONSTRUCTION
  # ============================================
  construction:
    name: Construction et VÃ©rification
    runs-on: ubuntu-latest

    steps:
      # ============================================
      # ğŸ“¦ RÃ©cupÃ©rer le code
      # ============================================
      - name: ğŸ“¥ RÃ©cupÃ©rer le code
        uses: actions/checkout@v3

      # ============================================
      # ğŸ”§ Installer Node.js
      # ============================================
      - name: ğŸ”§ Configurer Node.js 20
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      # ============================================
      # ğŸ“¦ Installer les dÃ©pendances
      # ============================================
      - name: ğŸ“¦ Installer les dÃ©pendances npm
        run: npm ci

      # ============================================
      # ğŸ§¹ VÃ©rifier la qualitÃ© du code (Linting)
      # ============================================
      - name: ğŸ§¹ VÃ©rifier la qualitÃ© du code JavaScript
        run: |
          echo "ğŸ” VÃ©rification ESLint..."
          npm run lint 2>/dev/null || echo "âš ï¸  Pas de configuration ESLint"

      # ============================================
      # ğŸ§ª Tests automatisÃ©s React
      # ============================================
      - name: ğŸ§ª ExÃ©cuter les tests JavaScript
        run: |
          echo "ğŸ§ª Tests JavaScript..."
          npm run test -- --run --coverage 2>/dev/null || echo "âš ï¸  Pas de tests configurÃ©s"

      # ============================================
      # ğŸ—ï¸ Construire les assets
      # ============================================
      - name: ğŸ—ï¸ Construire les assets de production
        run: |
          echo "ğŸ—ï¸ Construction en cours..."
          npm run build
          echo "âœ… Construction rÃ©ussie!"

      # ============================================
      # âœ… VÃ©rifier la construction
      # ============================================
      - name: âœ… VÃ©rifier la construction
        run: |
          if [ ! -d "public/build" ]; then
            echo "âŒ Erreur: dossier public/build introuvable"
            exit 1
          fi
          echo "âœ… Dossier public/build existe"
          echo "ğŸ“Š Fichiers gÃ©nÃ©rÃ©s:"
          ls -lh public/build/assets/ | head -15

      # ============================================
      # ğŸ” Audit de sÃ©curitÃ©
      # ============================================
      - name: ğŸ” Audit de sÃ©curitÃ© npm
        run: |
          echo "ğŸ” VÃ©rification des vulnÃ©rabilitÃ©s..."
          npm audit --audit-level=moderate 2>/dev/null || echo "âš ï¸  Quelques vulnÃ©rabilitÃ©s dÃ©tectÃ©es"

      # ============================================
      # ğŸ“Š Rapport de taille
      # ============================================
      - name: ğŸ“Š Rapport de taille du bundle
        run: |
          echo "ğŸ“¦ Analyse de la taille du bundle:"
          echo "=================================="
          du -h public/build/assets/app*.js 2>/dev/null | tail -3 || true
          echo ""
          du -sh public/build/ 2>/dev/null || true
          echo "âœ… Rapport gÃ©nÃ©rÃ©"

      # ============================================
      # ğŸ“ˆ TÃ©lÃ©charger le rapport de couverture
      # ============================================
      - name: ğŸ“ˆ Rapport de couverture de code
        if: always()
        run: |
          echo "ğŸ“ˆ Rapport de couverture:"
          if [ -d "coverage" ]; then
            du -sh coverage/
            echo "âœ… Couverture gÃ©nÃ©rÃ©e"
          else
            echo "âš ï¸  Pas de rapport de couverture"
          fi

  # ============================================
  # ğŸš€ DÃ‰PLOIEMENT AUTOMATIQUE (OPTIONNEL)
  # ============================================
  deploiement:
    name: DÃ©ploiement automatique
    runs-on: ubuntu-latest
    needs: construction
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ RÃ©cupÃ©rer le code
        uses: actions/checkout@v3

      - name: ğŸš€ DÃ©ployer vers le serveur
        run: |
          echo "ğŸš€ PrÃ©paration du dÃ©ploiement..."
          echo "âœ… DÃ©ploiement prÃªt (configurer SSH au besoin)"
          # Ã€ configurer avec vos clÃ©s SSH

  # ============================================
  # ğŸ’¬ NOTIFICATIONS
  # ============================================
  notifications:
    name: Notifications
    runs-on: ubuntu-latest
    needs: [construction]
    if: always()
    
    steps:
      - name: âœ… SuccÃ¨s - Notifier Slack
        if: needs.construction.result == 'success'
        run: |
          echo "âœ… Pipeline rÃ©ussi!"
          echo "- Construction: âœ…"
          echo "- Tests: âœ…"
          echo "- Linting: âœ…"
          echo "- Audit sÃ©curitÃ©: âœ…"
          echo ""
          echo "PrÃªt Ã  merger! ğŸ‰"

      - name: âŒ Ã‰chec - Notifier Slack
        if: needs.construction.result == 'failure'
        run: |
          echo "âŒ Pipeline Ã©chouÃ©!"
          echo "Veuillez corriger les erreurs ci-dessus et repousser."
          exit 1
